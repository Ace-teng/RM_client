# 战术分析功能设计

> 基于裁判系统官方协议数据，对比赛态势进行分析并给出操作建议，辅助地面操作手决策。
> 数据来源：**仅使用官方协议**，不依赖射频破解等非官方手段。

---

## 一、功能概览

| 功能 | 输入数据 | 输出建议 | 依赖 |
|------|----------|----------|------|
| 追击/撤退建议 | 我方 vs 对方血量 | 「追击」「撤退」「谨慎」 | robot_states（HP） |
| 背后敌人提醒 | 双方位置、朝向 | 「背后来人」警示 | 位置数据（雷达/裁判） |
| 对方经济与补弹策略 | 对方经济 | 补弹节奏/策略推测 | game_state 或 robot_states |
| 买活预警 | 对方经济、买活规则 | 屏幕中央醒目提醒 | game_state |

---

## 二、数据流（符合 R-ARCH-003）

```
protocol → DataCenter (game_state, robot_states)
                ↓
         TacticalAdvisor (service)
                ↓ 只读 dc，计算后写入 dc.tactical_advice
         DataCenter.tactical_advice
                ↓
         UI 订阅并展示（TacticalOverlay、TacticalPanel）
```

---

## 三、DataCenter 扩展

新增字段：

- `tactical_advice`：战术建议对象，包含：
  - `hp_suggestion`: `"追击" | "撤退" | "谨慎" | None`
  - `hp_diff`: 血量差（我方 - 对方），用于 UI 显示
  - `enemy_behind`: bool，是否检测到背后来人
  - `economy_hint`: str，对方经济/补弹策略提示
  - `buyback_alert`: bool，是否应显示买活预警

---

## 四、TacticalAdvisor 服务

**位置**：`rm_client/core/service/tactical_advisor.py`

**职责**：定时（如每 500ms）从 DataCenter 读取 `game_state`、`robot_states`，计算建议并写回 `dc.tactical_advice`。

**逻辑（占位，待协议接入后按真实字段调整）**：

1. **追击/撤退**：汇总我方与对方 HP，若我方优势 > 阈值 → 追击，劣势 > 阈值 → 撤退，否则谨慎
2. **背后敌人**：有位置与朝向后，判断敌方是否在己方后方（可后续实现）
3. **经济提示**：根据对方经济推断补弹倾向（高/中/低）
4. **买活预警**：对方经济超过买活阈值时置 `buyback_alert=True`

---

## 五、UI 设计

### 5.1 战术建议条（图传区上方或侧边）

- 显示：追击/撤退/谨慎 + 血量差
- 样式：颜色区分（绿=追击，红=撤退，黄=谨慎）
- 可开关

### 5.2 买活预警（屏幕中央）

- 大字号、高对比度：「注意：对方可能买活」
- 仅在 `buyback_alert=True` 时显示
- 可配置显示时长或持续显示直到经济变化

### 5.3 经济/补弹提示（右侧面板）

- 在战术建议区域展示 `economy_hint`
- 如：「对方经济充足，可能频繁补弹」

### 5.4 背后敌人警示

- 在图传区叠加醒目边框或文字：「背后来人」
- 仅在 `enemy_behind=True` 时显示

---

## 六、实现顺序

| 阶段 | 内容 | 前置条件 |
|------|------|----------|
| 1 | DataCenter 增加 `tactical_advice`，TacticalAdvisor 骨架 | 无 |
| 2 | 追击/撤退逻辑（基于现有 robot_states 占位结构） | 无 |
| 3 | 战术建议条 UI | 阶段 1 |
| 4 | 买活预警 UI | 协议有经济/买活字段 |
| 5 | 经济提示 UI | 协议有经济字段 |
| 6 | 背后敌人（含逻辑 + UI） | 有位置数据源 |

---

## 七、配置项（config.default）

| 配置名 | 默认值 | 说明 |
|--------|--------|------|
| TACTICAL_MY_TEAM | "blue" | 己方阵营，环境变量可覆盖 |
| TACTICAL_HP_DIFF_THRESHOLD | 150 | 血量差阈值，超过则追击/撤退 |
| TACTICAL_BUYBACK_ECONOMY_THRESHOLD | 1000 | 买活经济阈值，以当届规则为准 |

---

## 八、DataCenter 数据结构要求

TacticalAdvisor 从 DataCenter 读取以下结构，**referee_parser 必须保证输出兼容**：

### robot_states

```python
# Dict[robot_id: str, dict]
# 每项需包含：
{
    "hp": int,      # 当前血量
    "team": str,    # "red" | "blue"
    # 可选（背后敌人需用）："x", "y", "yaw" 等
}
```

### game_state

```python
# 需包含（至少其一，供经济解析）：
# red_economy: int
# blue_economy: int
# 或 enemy_economy: int（对方经济）
```

---

## 九、协议字段映射（referee_parser 接入时）

当接入真实《RoboMaster 通信协议》后，referee_parser 需将 Proto 字段映射为上述结构：

| 协议来源 | 映射目标 | 说明 |
|----------|----------|------|
| 机器人状态消息（如 RobotStatus） | robot_states[robot_id].hp | 当前血量 |
| 机器人状态消息 | robot_states[robot_id].team | 阵营标识 |
| 经济/比赛状态消息 | game_state.red_economy / blue_economy | 双方经济 |
| 位置消息（若有） | robot_states[robot_id].x, .y, .yaw | 背后敌人逻辑用 |

具体 Proto 消息名与字段以当届《RoboMaster 机甲大师高校系列赛通信协议》为准。TacticalAdvisor 仅依赖 DataCenter 中的上述字段名，不直接依赖 Proto 结构。
