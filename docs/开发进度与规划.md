# RoboMaster 自定义客户端 — 开发进度与规划

> 本文档描述当前已实现功能与后续开发规划。架构约束与详细需求见 `CustomClient_Architecture.md`。

---

## 一、已实现功能

### Phase 1：基础框架 ✅

- 项目目录结构（六层：comms、protocol、model、service、ui、plugins）
- QtPy 主窗口可启动
- DataCenter 单例创建，subscribe/notify 机制
- 单向数据流（comms → protocol → DataCenter → service → ui）

### Phase 2：通信打通 ✅

- MQTT 连接赛事引擎（默认 192.168.12.1:3333）
- 订阅、接收数据、日志打印
- 支持 `--local` 切换本机 MQTT（127.0.0.1:1883）
- UDP 图传接收（端口 3334），原始包回调

### Phase 3：协议解析 ✅

- Protobuf 解析（GameStatus 占位消息）
- 解析结果写入 DataCenter
- 图传 8 字节包头解析、分片重组、HEVC 解码（PyAV，可选）
- Topic 与消息格式为占位，待真实协议接入后替换

### Phase 4：最小可用 UI ✅

- 中心图传显示区（QGraphicsView），无图传时显示「图传未连接」
- 赛事状态面板：比赛阶段、剩余时间、血量占位
- 状态栏显示 game_phase / remaining_time_sec
- 线程安全更新（Qt signals）

### Phase 5：态势界面 ✅

- 态势图（MapWidget）：简化战场矩形，机器人位置标记（归一化坐标）
- 机器人状态列表（RobotStatusList）：ID、阵营、血量
- 占位 robot_states 数据（demo_data），协议接入后由 protocol 覆盖

### Phase 6：控制功能 ✅

- 赛事指令面板：性能体系 1/2/3、兑换发弹量、空中支援
- CommandSender 服务，protocol 层序列化 + comms 层 publish
- MQTT 未连接时按钮点击弹窗提示

### Phase 7：插件机制 ✅

- 插件接口（PluginBase、PluginContext）
- 插件加载器：动态发现 plugins 子包与 plugin_*.py
- 主窗口插件区域，add_plugin_widget 供插件挂载 UI
- 示例插件（示例插件已加载、点击刷新状态）

### 测试与脚本

- `test_phase3_parse_only.py`：协议解析 + DataCenter 写入
- `test_phase7_plugins.py`：插件发现与加载
- `publish_game_status.py`：发布 GameStatus 到 MQTT
- `send_test_video_udp.py`：发送 HEVC 测试流到 3334
- `TEST_COMMANDS.md`：测试命令汇总

### 当前技术栈

| 类别     | 实现 |
|----------|------|
| UI       | QtPy（QMainWindow、QGraphicsView、QFrame 等） |
| 赛事通信 | paho-mqtt |
| 协议     | protobuf（占位 .proto） |
| 图传解码 | PyAV（av，可选） |
| 架构     | 六层、DataCenter 单例、单向数据流 |

---

## 二、待实现功能

### 近期（协议与诊断）

#### 2.1 接入真实赛事协议

- 使用官方 `.proto` 及 `protoc` 生成代码
- 更新 Topic 列表与消息结构
- 调整 `referee_parser`、`command_serializer` 以符合真实协议
- 根据协议更新 DataCenter 数据结构（game_state、robot_states 等）

#### 2.2 诊断与联调面板（§5.1.3）

- MQTT 连接状态、图传连接状态
- 数据最近更新时间（「多久前更新」）
- 丢包 / 超时计数
- 一键复制诊断信息到剪贴板
- 可选：一键导出日志

---

### 中期（UI 与核心能力）

#### 2.2.1 战术分析（已实现骨架）

- **TacticalAdvisor**：基于 robot_states、game_state 计算建议，写入 dc.tactical_advice
- **追击/撤退建议**：血量差 > 阈值 → 追击/撤退/谨慎
- **战术建议面板**：显示血量对比与建议
- **买活预警**：对方经济超阈值时，图传区中央醒目提醒
- **经济提示**：对方补弹策略推测（占位，待协议有经济字段）
- **背后敌人**：待有位置数据后实现
- 设计文档：`docs/战术分析功能设计.md`

#### 2.3 UI 优化

- 态势图样式与交互优化
- 赛事指令面板布局与视觉反馈
- 整体界面风格与信息层级
- 图传源切换（多车时选择看哪台车画面）

#### 2.4 透视框（HUD）（§5.1.1）

- 在图传上叠加多目标框、标签、附加信息
- 总开关、调试开关
- 超时隐藏、断流自动消失
- 框稳定跟随目标
- 数据来源：雷达或裁判系统分发

#### 2.5 标定（§5.1.2）

- 标定页面入口（进入 / 退出、重试）
- 状态四态：未开始 / 进行中 / 成功 / 失败
- 失败原因、最近标定结果
- ArUco 引导（对准同一 ArUco、等待标定完成）
- 状态实时刷新、失败可重试、成功明确确认

---

### 长期（扩展与设备接入）

#### 2.6 雷达与设备间接入（§5.2.1）

- 在赛事规则允许前提下，与雷达站等 LAN 接入（UDP/TCP）
- 重连、心跳、丢包 / 延迟 / 带宽 / 最近更新时间统计
- 雷达位姿、透视框坐标等数据接入 DataCenter

#### 2.7 自定义控制器有线通信

- 规则允许自定义客户端与自定义控制器有线通信
- 具体方式（串口 / USB / 有线以太网）由队伍实现
- 在 comms 层预留接入能力

#### 2.8 多屏 / 多角色视图（§0.4，待定）

- 按需实现：雷达视图、地面视图、综合视图
- 或：多物理屏、多窗口布局
- 不破坏现有分层与数据流

#### 2.9 录包与离线回放（可选）

- 记录 MQTT / 图传数据，离线回放调试

---

### 插件扩展

- 新功能优先以插件实现，保持主程序稳定
- 按需开发：数据导出、复盘分析等插件

---

## 三、建议实施顺序

| 优先级 | 任务                         | 条件 / 说明                   |
|--------|------------------------------|-------------------------------|
| 高     | 接入真实赛事协议             | 获得官方 .proto 与协议文档后  |
| 高     | 诊断面板                     | 可随时开发，便于联调排错      |
| 中     | 战术分析完善                 | 协议有经济字段后完善经济/买活 |
| 中     | UI 优化                      | 按使用反馈迭代                |
| 中     | 透视框                       | 有雷达或视觉目标框数据后      |
| 中     | 标定                         | 需要 ArUco 标定流程时         |
| 低     | 雷达 / 设备间接入            | 规则明确且具备硬件条件时      |
| 低     | 多屏视图、录包回放           | 按队伍需求决定                |

---

## 四、相关文档

- `CustomClient_Architecture.md` — 系统需求与架构设计总文档
- `TEST_COMMANDS.md` — 测试命令汇总
