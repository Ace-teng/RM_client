# RoboMaster 自定义客户端 系统需求与架构设计文档

**（System Requirements & Architecture Specification）**

> **本文档为需求与架构之唯一总文档，后续更新均在此进行。**

| 版本 | 作者 | 日期 | 状态 |
|------|------|------|------|
| v1.0 | 田志腾 | 2026 | Architecture Baseline |

**适用对象：** 开发人员 / 继任成员 / 系统维护者  

**约束：** 本文件是项目最高级技术约束文档。**任何实现不得违反本文档中标记为 MUST 的条款。**

---

## 1. 引言与目标

### 1.1 目的

本文档定义 RoboMaster 自定义客户端的**完整系统需求与架构边界**，用于：

- **指导**从 0 到 1 的系统实现
- **约束**后续开发行为
- **保证**跨届维护可持续性
- **防止**架构失控或功能耦合

### 1.2 系统定位

本客户端并非单机 GUI 程序，而是**多设备战术信息中枢（Tactical Information Hub）**，属于**分布式实时通信 + 可视化系统**。

系统需同时承担：裁判系统数据接入、图传显示、雷达数据融合、车端信息接入、局域网设备通信、战术可视化（HUD、态势图、控制面板）。

### 1.3 自定义客户端定义（赛事规范）

根据 RoboMaster 赛事规则，**自定义客户端**是参赛队伍自制的多用途设备，用于：

- **接收**赛事引擎服务器发送的比赛相关信息与机器人图传画面；
- **发送**赛事专用交互指令至赛事引擎服务器；
- **拓展**人机交互可能性，使队伍可不依赖官方裁判系统选手端完成比赛。

典型形态：显示设备 + 运算平台（存储器、控制器、运算器）+ 输入设备；或一体化设备（如带网口的手持平板）。通过操作间 RJ45 有线接入赛事引擎服务器，与自定义控制器可有线通信。

### 1.4 本项目目标

- 接收赛事引擎服务器赛事数据（MQTT + Protobuf）、机器人图传（UDP，HEVC）
- 展示比赛信息与态势感知（双方血量、己方经济、剩余时间、关键事件播报等）
- 发送选手端支持的赛事指令（赛前性能体系选择、赛中兑换发弹量、空中支援等）
- 支持功能扩展与长期维护、多届成员持续迭代开发

系统须满足：**Maintainability / Extensibility / Modularity / Decoupling / Readability**。**本项目定位为队伍长期基础设施，而非一次性工具软件。**

### 1.5 赛事通信规范（与规则一致）

| 项目 | 规范 |
|------|------|
| 数据格式 | Protobuf v3（Protocol Buffers） |
| 赛事数据传输 | MQTT 发布/订阅，直接传输 Protobuf 序列化二进制流 |
| Topic | 对应指令/消息名（见赛事通信协议文档） |
| 赛事引擎服务器 | 固定 IP：192.168.12.1，端口：3333 |
| 自定义客户端 IP | DHCP 自动分配 |
| 图传 | UDP 监听端口 **3334**，编码格式 **HEVC** |

**MQTT 通信流程：** 按赛事文档编写 `.proto` → `protoc` 生成代码 → 发布端序列化 → MQTT publish 到 Topic → 订阅端 Protobuf 反序列化。

**图传 UDP 包格式：** 每个 UDP 包码流数据前 **8 字节** 固定为：帧编号（2 byte）、当前帧内分片序号（2 byte）、当前帧总字节数（4 byte）；之后为 HEVC 码流。实现时需按此包头做分片重组与解码。

**参考赛事文档：** 《RoboMaster 通信协议》；《附录三：自定义客户端示例通信代码》。

---

## 2. 总体架构要求（MUST）

| 需求 ID | 名称 | 约束 | 内容 |
|---------|------|------|------|
| **R-ARCH-001** | 分层架构 | MUST | 系统必须采用六层设计：通信层、协议层、数据层（Data Center）、业务层、表现层、插件层。禁止跨层直接依赖。 |
| **R-ARCH-002** | 单一数据源 | MUST | 所有比赛状态数据必须集中存储于 DataCenter。禁止：UI 保存副本、模块私有缓存、多处状态源。 |
| **R-ARCH-003** | 单向数据流 | MUST | 数据流方向必须为：**通信 → 协议 → 数据 → 业务 → UI**。不得逆向。 |

**六层说明：**

| 层级 | 英文名 | 说明 |
|------|--------|------|
| 通信层 | Communication Layer | 网络收发（赛事 MQTT/UDP + 设备间 LAN） |
| 协议层 | Protocol Layer | 协议解析与分发 |
| 数据层 | Data Center | 状态存储与访问（唯一数据源） |
| 业务层 | Service Layer | 战术、报警、融合、推理 |
| 表现层 | Presentation Layer | 展示与交互 |
| 插件层 | Plugins Layer | 扩展功能、试验性模块 |

**其他原则：** 职责单一（通信不解析协议、协议不涉及 UI、UI 不含算法）；可扩展（新功能通过模块/插件实现，不修改核心代码）；可交接（目录清晰、命名规范、文档齐全、无隐式逻辑）。

---

## 3. 系统目录结构

项目目录固定如下，**禁止随意更改层级**：

```
rm_client/
├── main.py
├── core/
│   ├── comms/      # 通信层（赛事 + 设备间）
│   ├── protocol/   # 协议层
│   ├── model/      # 数据层（DataCenter）
│   ├── service/    # 业务层
│   ├── bus/        # 事件总线（R-BUS-*）
│   ├── pose/       # 坐标系与标定（R-POSE-*）
│   ├── time_sync/  # 时间同步（R-TIME-*）
│   └── replay/     # 录包与回放（R-DBG-*）
├── ui/
│   ├── hud/        # 叠加显示
│   ├── radar/      # 态势地图
│   └── control/    # 操作面板
├── plugins/        # 插件层
├── config/
└── docs/
```

---

## 4. 模块职责定义

### 4.1 comms（通信层）

- **赛事链路**：MQTT（192.168.12.1:3333）订阅/发布、Protobuf 二进制流；UDP 图传 3334、8 字节包头 HEVC；向赛事引擎发送指令。
- **设备间链路**（R-COM-*）：局域网 UDP/TCP、单向/双向发送、自动重连、心跳检测、丢包率/延迟/带宽/最近更新时间统计；可选消息序列号与乱序重排（雷达站、地面机器人、客户端终端等）。

**输入/输出：** 输入为网络字节流；输出为原始字节流（按 Topic/端口区分，不解析内容）。**禁止：** 协议解析、状态存储、UI 调用。

### 4.2 protocol（协议层）

Protobuf v3 反序列化、Topic 分发、图传 8 字节包头解析与 HEVC 重组；字节流 → 结构化对象（以赛事协议为准）。**禁止：** 网络连接、UI 操作、业务逻辑。

### 4.3 model（数据层）

存储所有比赛实时状态、统一读写接口、全局数据中心；单例、线程安全、支持订阅通知（Signal/Observer）。示例字段：`game_state`、`robot_states`、`events`、`video_frame`。**本模块是全系统唯一状态源。**

### 4.4 service（业务层）

报警逻辑、战术计算、数据融合、推理与预测。只读写 DataCenter，不操作 UI。

### 4.5 ui（表现层）

界面显示、用户交互、指令触发。子模块：hud、radar、control。**限制：** 不包含算法、不解析协议、只读 DataCenter。功能要求见第 5 章表现层需求。

### 4.6 plugins（插件层）

未来扩展、试验性模块、新策略或新界面。插件独立加载、不修改主程序；**新增功能优先在此实现。**

---

## 5. 功能需求

### 5.1 表现层（Presentation Layer）

| 类别 | 内容 |
|------|------|
| **基础 UI** | 主窗口（QMainWindow）、图传显示区域（QGraphicsView）、控制面板、状态栏 |
| **HUD 叠加** | 目标框绘制、标签显示、信息叠加、开关控制、实时刷新 |
| **状态展示** | 双方血量、经济、时间、比赛事件、连接状态 |
| **诊断功能** | 丢包统计、延迟统计、一键导出日志 |

### 5.2 基础设施层（Infrastructure）⭐

以下为系统长期可用性的关键；缺失任意一项，可维护性将显著下降。

**5.2.1 设备间通信（R-COM-*）** — 归属：core/comms

| 需求 ID | 约束 | 内容 |
|---------|------|------|
| R-COM-001 | MUST | 支持局域网 UDP/TCP 通信能力。 |
| R-COM-002 | MUST | 支持单向或双向数据发送。 |
| R-COM-003 | MUST | 支持设备自动重连。 |
| R-COM-004 | MUST | 支持心跳机制检测在线状态。 |
| R-COM-005 | MUST | 统计：丢包率、延迟、带宽、最近更新时间。 |
| R-COM-006 | SHOULD | 支持消息序列号与乱序重排。 |

典型数据类型：雷达位姿矩阵、透视框像素坐标、机器人定位数据。

**5.2.2 坐标系与标定（R-POSE-*）** — 归属：core/pose

| 需求 ID | 约束 | 内容 |
|---------|------|------|
| R-POSE-001 | MUST | 维护统一坐标注册表。 |
| R-POSE-002 | MUST | 支持任意两坐标系间变换计算。 |
| R-POSE-003 | MUST | 支持外参矩阵存储与更新。 |
| R-POSE-004 | MUST | 提供统一接口：`transform(point, src, dst)`。 |
| R-POSE-005 | SHOULD | 支持历史缓存与插值。 |

**5.2.3 消息总线（R-BUS-*）** — 归属：core/bus

| 需求 ID | 约束 | 内容 |
|---------|------|------|
| R-BUS-001 | MUST | 实现统一事件总线。 |
| R-BUS-002 | MUST | 支持 publish/subscribe 模式。 |
| R-BUS-003 | MUST | 模块之间不得直接互相调用。 |

**5.2.4 时间同步（R-TIME-*）** — 归属：core/time_sync

| 需求 ID | 约束 | 内容 |
|---------|------|------|
| R-TIME-001 | MUST | 所有数据必须携带时间戳。 |
| R-TIME-002 | MUST | 系统维护缓冲队列。 |
| R-TIME-003 | MUST | 支持插值或延迟补偿。 |
| R-TIME-004 | SHOULD | 支持统一系统时钟同步。 |

**5.2.5 调试与回放（R-DBG-*）** — 归属：core/replay

| 需求 ID | 约束 | 内容 |
|---------|------|------|
| R-DBG-001 | SHOULD | 支持数据录包。 |
| R-DBG-002 | SHOULD | 支持离线回放。 |

作用：无机器人即可调试，提升开发效率。

---

## 6. 数据流规范

统一数据流（R-ARCH-003）：

1. **comms** 接收数据  
2. **protocol** 解析  
3. 写入 **DataCenter**  
4. **service** 处理（可读事件总线、坐标变换、时间同步）  
5. **ui** 显示  

**任何模块不得绕过此流程或逆向调用。** 模块间通过事件总线（publish/subscribe）解耦，禁止直接互相调用。

---

## 7. 开发阶段规划

| 阶段 | 目标 |
|------|------|
| Phase 1：基础框架 | 完成目录结构、Qt 主窗口可启动、DataCenter 创建 |
| Phase 2：通信打通 | MQTT 可连接、接收数据日志打印 |
| Phase 3：协议解析 | protobuf 解析成功、数据写入 DataCenter |
| Phase 4：最小可用 UI | 图传显示、血量展示 |
| Phase 5：态势界面 | 地图、机器人位置、关键状态 |
| Phase 6：控制功能 | 发送赛事指令 |
| Phase 7：插件机制 | 动态加载插件、支持后续扩展 |

---

## 8. 开发规范与非功能需求

**必须遵守：** 禁止跨层依赖；禁止大文件（单文件 >800 行必须拆分）；新功能优先新模块；公共接口必须写文档注释；重要逻辑必须可测试。

| 类别 | 要求 |
|------|------|
| **可维护性** | 单文件 ≤ 800 行；强制模块化。 |
| **可扩展性** | 新功能通过插件实现。 |
| **可交接性** | 必须配套文档（见第 9 章）。 |

---

## 9. 交接要求

项目交付时必须包含：

- **本总文档**（系统需求与架构设计）
- 赛事通信协议文档引用与所用协议版本说明（如 Protobuf 消息版本、Topic 列表）
- 模块说明
- 快速启动指南
- 示例插件
- 代码注释完整

**否则视为不可交接项目。**

---

## 10. 结论

本系统由**表现层**（UI / HUD / 渲染）与**基础设施层**（设备通信、坐标变换、消息总线、时间同步、调试回放）构成。采用六层分层架构、单一数据源（DataCenter）、单向数据流、模块化设计、插件式扩展。**基础设施层是长期稳定运行的核心。**

该结构可确保：多年维护、规则变更可适配、新成员低成本接手。

**任何实现不得违反本文档中 MUST 条款；任何偏离本架构的实现均不建议合入主分支。**
